---
layout: post
title: Invitation links expiration authentication logic flaw
subtitle: 
tags: [write-up, high, p2]
comments: false
published: false
---

## Introduction

I recently stumbled upon an authentication logic flaw on one of my favorite bug bounty program. I reported it as a P2/High impact vulnerability and after a little while, got rewarded with a nice 1500$ bounty. 

I had never heard of this vulnerability before anywhere on Twitter or on any write-ups. So I realized that I had (finally!) been thinking out of the box!

Being very familiar with this program made me think out of the box, but that authentication logic flaw was definitely not related to the program's business. That meant I had to start looking for this flaw in other programs.

I started by confirming the program owners' reaction to this new bug by also reporting a slightly different version to another program I'm familiar with and got my bug accepted as well as a P3/Medium this time. That was the confirmation for me that my next step was to step back a little and look at it at a bigger scale.

## Background

I've worked in enough companies to realize that firing employees are part of any organization's life-cycle. Fortunately, Sometimes it goes smoothly enough, but sometimes, it's another story...

The company has to take measures to revoke any API tokens the employee had access to, revoke ssh keys, remove access to any third-party systems, etc...

With all companies moving to a more remote-friendly setup, this is even more crucial to make sure that is done properly. Device enrollment services such as [apigee.com](https://apigee.com) can help to lock any employee's computer distantly but sometimes, this is not enough...

As a SaaS product, you definitely do not want to be responsible for a breach in one of your customer organizations caused by fired employees who decided to take their revenge. This is exactly what this vulnerability allows us to achieve.

## Authentication logic flaws

### Invitation links expiration 

Many SaaS products provide "invitation links" that admins can use to invite new employees. There are two kinds of invitation links:

#### Many-time use invitation links.

Many-time use invitation links are really handy because they allow admins to integrate into their onboarding documents and facilitate new employees setup.

From a security perspective though, they are the worst kind of invitation links. Any employee who got access to one of those links will be able to reuse them indefinitely to create new accounts, especially after they left the company, at their own will, or not... 

Those many-time use invitation links should simply not be a solution to facilitate new employee's onboarding as they come with too many risks of being leaked. They are particularly bad because any employee, from the CEO to the interns, have access to them at least once during their employment time.

Even if the links have an expiration date, there is always going to be a time range when an angry employee who just got fired could leverage them.


#### One-time use invitation links.

One-time use invitation-links generated by administrators allowing to create one account only are a much stronger design. If implemented properly they are a good way to reduce the risk of a leak caused by an ex-employee.

The problem with those one-time invitation links is that employees can generate one for themselves, keep it in their personal notes, and use it after they got fired from the company.

**You should always verify upon registration that the account who generated the invitation link was not disabled**

One might argue that this is intended behavior as the admin might no longer be active, but they had sent a valid invitation to another user prior to the deactivation of their account. Regarding the exceptional circumstances though, it can be understood that this new employee asks a new invite from another admin, keeping the integrity of the organization.

Similarly, an employee could see his permission level reduced in software. Using this technique, I have seen cases where it was possible to gain back revoked privileges.

**You should always verify upon registration that the account who generated the invitation link does not have fewer privileges than the newly created account**

## Email invitations

Email invitations are the most common way of inviting new employees to join an organization.  

Employees aware that they are about to get fired could send an invitation to one of their personal emails and achieve the same attack that way. In this case it should be easier to detect by the account owner because they will see that a new strange account is registered while they disable the employee's account and should be able to connect the dots. That is easier for the account owner to realize that something is wrong if the pending accounts are listed alongside active accounts in the user list. Otherwise, it's really easy to miss.

At the moment, I haven't reported this as a vulnerability to bug bounty programs because I do consider that since in that case, the account was created before the employee got deactivated, it is the account owner's duty to verify all other accounts are legitimate while they deactivate the employee's account. Ideally though, same as before, you should always verify that the account who generated the invite is still active.

## Approved domains self-registration

Approved domains self-registration is a great onboarding design as well. Allowing anyone who owns an email address with your company's domain should be secure by design. Employees have only one email address and therefore, once their account was revoked, they should not be able to ever reintegrate the system.

The problem with that approach comes from [email specifications RFC822](https://tools.ietf.org/html/rfc822) themselves.
Let's say that my company uses a third party system allowing domain self-registration for the following domain `nkix.xyz`. Now I can self register an account using my address `me@nkix.xyz`, but I can also register a second account using `+` sign as such: `me+anythingiwant@nkix.xyz`. The registration email will be sent to `me@nkix.xyz` because anything that comes after the + is ignored. This is considered as a comment.

Using such techniques, any employees could keep a valid invitation link in order to re-join the organization after they got fired.

**You should make sure you forbid any new signup from ^john.doe+.*@domain\.com$ if john.doe@domain.com (and also john.doe+somethingelse@domain.com) was previously deactivated.**

Note: [Email specifications](https://tools.ietf.org/html/rfc822) also allow for `(comment)me@nkix.xyz` or even `me@(comment)nkix.xyz`. But most systems will not allow for parenthesis in email address upon registration, making it impossible to leverage in the scenario described above. 

### General recommandations for mitigation

Here are few advices that will help mitigate this vulnerability:
 - Verify upon registration that the account who generated the invitation link was not disabled.
 - Verify upon registration that the account who generated the invitation link does not have fewer privileges than the newly created account.
 - Send an email to account owner when a new user signup.
 - Ask for account owner approval before new sign up can access sensitive data.
 - List pending users in the users list. That way, when admins delete employees accounts, they can visualy verify wether there are suspicious pending accounts.

### Reporting at scale

After getting my first submissions validated, I started to increasingly submit more of those reports to public programs on one of the main platform first.

The biggest issue I have been facing since I started to report this new vulnerability to public programs is that time to triage has increased consequently compared to my other reports. Platform triagers have never heard of it before, hence, they are reluctant triaging and ask for more details, claiming that this might be intended behavior despite being obviously insecure by design. 

Triagers will often not triage first, and ask for program's take, which increases the chances of getting the issue being triaged as informative. Fortunately so far, program managers have understood the potential impact pretty well and triaged this vulnerability appropriately.

That's totally fair that triagers are asking questions. That's one of the reasons I'm writing this blog post, to help triagers and program owners understand this vulnerability better.

### Takeaways

#### For bug bounty hunters

Think out of the box...
Easier said than done! I'm the worst person to give this advice to be honest... 

I've heard it so many times in my engineering and bug hunter careers and I always felt like a complete failure because I was never able to really do it. 

My real advice for hunters would be to familiarise yourself enough with one program that you absolutely master. Use it as a structure to dig deeper and you might find vulnerabilities that nobody (or only a few) have found before.

#### For developers

It is possible to make a secure invitation system without compromising with new employee onboarding. You have to think about it carefully and put the right amount of effort into it. Make sure your product team understands the development cost and security implications.

